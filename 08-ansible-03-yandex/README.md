# Домашнее задание к занятию 3 «Использование Ansible»

## Подготовка к выполнению

1. Подготовьте в Yandex Cloud три хоста: для `clickhouse`, для `vector` и для `lighthouse`.
2. Репозиторий LightHouse находится [по ссылке](https://github.com/VKCOM/lighthouse).

## Основная часть

1. Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает LightHouse.
2. При создании tasks рекомендую использовать модули: `get_url`, `template`, `yum`, `apt`.
3. Tasks должны: скачать статику LightHouse, установить Nginx или любой другой веб-сервер, настроить его конфиг для открытия LightHouse, запустить веб-сервер.
4. Подготовьте свой inventory-файл `prod.yml`.
5. Запустите `ansible-lint site.yml` и исправьте ошибки, если они есть.
6. Попробуйте запустить playbook на этом окружении с флагом `--check`.
7. Запустите playbook на `prod.yml` окружении с флагом `--diff`. Убедитесь, что изменения на системе произведены.
8. Повторно запустите playbook с флагом `--diff` и убедитесь, что playbook идемпотентен.
9. Подготовьте README.md-файл по своему playbook. В нём должно быть описано: что делает playbook, какие у него есть параметры и теги.
10. Готовый playbook выложите в свой репозиторий, поставьте тег `08-ansible-03-yandex` на фиксирующий коммит, в ответ предоставьте ссылку на него.

---

### Как оформить решение задания

Выполненное домашнее задание пришлите в виде ссылки на .md-файл в вашем репозитории.

---

### Решение.

В яндекс облаке подготовливаются 3 ВМ посредством терраформ.
Данные из output terraform передаются в файл инвентаря для ansible.
При создании ВМ в яндекс облаке использется ОС Centos Stream OS 8.
Общий плейбук переработан под данную ОС.

Добавлены дополнительные таски:
Для установки кликхаус добавлена таска ожидания прослушивания порта. Это необходимо для того, чтобы плейбук не прерывался после установки пакетов и перед таской создания БД. В изначальном плейбуке БД создавалась сразу после установки пакетов и падала ввиду проблем с портом 9000 (используется по умолчанию кликхаус БД)

```   
- name: Check if port 9000 is listening
      wait_for:
        port: 9000
        delay: 5
        timeout: 30
        msg: "Timeout waiting for 9000 to respond"
```
После того как порт 9000 становится доступен, запускается таск по созданию БД.

```
    - name: Create database
      ansible.builtin.command: "clickhouse-client -q 'create database logs;'"
      register: create_db
      failed_when: create_db.rc != 0 and create_db.rc !=82
      changed_when: create_db.rc == 0
```

Плейбук для настройки ВМ с Лайтхаус.

Хэндлер по перезапуску Nginx

```  - name: Nginx reload
    become: true
    ansible.builtin.service:
      name: nginx
      state: restarted
```

Пре-таски по установке пакетов git и добавлению репозитория для скачивания nginx

```  
pre_tasks:
   - name: install git and repo
     ansible.builtin.dnf:
      name:
        - git
        - epel-release
      state: present
```
Установка nginx

```  
    - name: nginx install
      ansible.builtin.dnf:
        name: nginx
        state: present
        ```

Создание конфига для nginx

```    - name: Apply nginx config
      ansible.builtin.template:
        src: nginx.conf.j2
        dest: /etc/nginx/nginx.conf
        mode: 0644
        ```

Копирование гит-репозитория Лайтхаус в определнную папку на ВМ

```    - name: copy from git
      ansible.builtin.git:
        repo: "{{ light_repo }}"
        version: master
        dest: "{{ light_dir }}"
        ```

Изменение selinux контекста, для папок Лайтхаус

```    - name: change selinux contex
      ansible.builtin.file:
        path: "{{ light_dir }}"
        setype: httpd_sys_content_t
        recurse: true```

Копирование конфига Лайтхаус

```    - name: Create Lighthouse config
      ansible.builtin.template:
        src: lighthouse.conf.j2
        dest: /etc/nginx/conf.d/lighthouse.conf
        mode: 0644
      notify: Nginx reload
```

Код выполнения плейбука:

```
[mailo@fedora playbook]$ ansible-playbook site.yml 

PLAY [Install Clickhouse] **************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************
ok: [clickhouse_vm]

TASK [Get clickhouse distrib] **********************************************************************************************************************************************************************************************
changed: [clickhouse_vm] => (item=clickhouse-client)
changed: [clickhouse_vm] => (item=clickhouse-server)
failed: [clickhouse_vm] (item=clickhouse-common-static) => {"ansible_loop_var": "item", "changed": false, "dest": "./clickhouse-common-static-22.3.3.44.rpm", "elapsed": 0, "item": "clickhouse-common-static", "msg": "Request failed", "response": "HTTP Error 404: Not Found", "status_code": 404, "url": "https://packages.clickhouse.com/rpm/stable/clickhouse-common-static-22.3.3.44.noarch.rpm"}

TASK [Get clickhouse distrib] **********************************************************************************************************************************************************************************************
changed: [clickhouse_vm]

TASK [Install clickhouse packages] *****************************************************************************************************************************************************************************************
changed: [clickhouse_vm]

TASK [Flush handlers] ******************************************************************************************************************************************************************************************************

RUNNING HANDLER [Start clickhouse service] *********************************************************************************************************************************************************************************
changed: [clickhouse_vm]

TASK [Check if port 9000 is listening] *************************************************************************************************************************************************************************************
ok: [clickhouse_vm]

TASK [Create database] *****************************************************************************************************************************************************************************************************
changed: [clickhouse_vm]

PLAY [Install Vector] ******************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************
ok: [vector_vm]

TASK [Create dir for distrib] **********************************************************************************************************************************************************************************************
changed: [vector_vm]

TASK [Get Vector distrib] **************************************************************************************************************************************************************************************************
changed: [vector_vm]

TASK [Install Vector packages] *********************************************************************************************************************************************************************************************
changed: [vector_vm]

TASK [Apply Vector template] ***********************************************************************************************************************************************************************************************
changed: [vector_vm]

RUNNING HANDLER [Start Vector service] *************************************************************************************************************************************************************************************
changed: [vector_vm]

PLAY [Install LightHouse] **************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************
ok: [lighthouse_vm]

TASK [install git and repo] ************************************************************************************************************************************************************************************************
changed: [lighthouse_vm]

TASK [nginx install] *******************************************************************************************************************************************************************************************************
changed: [lighthouse_vm]

TASK [Apply nginx config] **************************************************************************************************************************************************************************************************
changed: [lighthouse_vm]

TASK [copy from git] *******************************************************************************************************************************************************************************************************
changed: [lighthouse_vm]

TASK [change selinux contex] ***********************************************************************************************************************************************************************************************
changed: [lighthouse_vm]

TASK [Create Lighthouse config] ********************************************************************************************************************************************************************************************
changed: [lighthouse_vm]

RUNNING HANDLER [Nginx reload] *********************************************************************************************************************************************************************************************
changed: [lighthouse_vm]

PLAY RECAP *****************************************************************************************************************************************************************************************************************
clickhouse_vm              : ok=6    changed=4    unreachable=0    failed=0    skipped=0    rescued=1    ignored=0   
lighthouse_vm              : ok=8    changed=7    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
vector_vm                  : ok=6    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

