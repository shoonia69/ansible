### Решение.

В яндекс облаке подготовливаются 3 ВМ посредством терраформ.
Данные из output terraform передаются в файл инвентаря для ansible.

Файл доступен по [ссылке](https://github.com/shoonia69/ansible/blob/main/08-ansible-03-yandex/playbook/inventory/prod.yml).
Содержимое файла:

```
all:
 children:
  clickhouse:
    hosts:
      clickhouse_vm:
       ansible_host: 51.250.0.240
  vector:
    hosts:
      vector_vm:
        ansible_host: 84.201.133.55
  lighthouse:
    hosts:
      lighthouse_vm:
         ansible_host: 62.84.119.39
```

При создании ВМ в яндекс облаке использется ОС Centos Stream OS 8.
Общий плейбук переработан под данную ОС.

В плейбуке используются слудующие тэги:

`Clickhouse` запускает все таски, связанные с кликхаус

`vector` запускает все таски, связанные с вектор

`ligh` tзапускает все таски, связанные с лайтхаус

`download` запускает все таски, связанные с скачиванием контента

`install` запускает все таски, связанные с установкой из репозиториев или рпм пакетов

`template` запускает все таски, связанные с применением шаблонов из папки темплейтов


Используются следующие переменные из папки `group_vars`:

Для кликхауса указывается какие версии пакетов нужно скачать.

`clickhouse_version` - номер версии кликхаус для скачивания.

`clickhouse_packages` - необходимые пакеты для скачивания.


Для вектор указывается необходимая версия, директория для скачивания и конфиг который передается в темплейт.

`vector_version` - версия вектора для скачивания.

`vector_distr_dir` - переменная для создания папки, куда будет скачан вектор и последующей его установки оттуда.

`vector_config` - конфиг вектора, который впоследвии обрабатывается j2.


Для лайтхауса указывается директория в которую клонируется репозиторий, адрес самого репозитория и пользователь под которым будет запускаться nginx.

`light_dir` - переменная отвечающая за создание папки куда скачать лайтхаус.

`light_repo` - переменная с описание адреса.

`light_user` - имя пользователя для запуска сервиса nginx, передается в шаблон первоначальной настройки nginx.


Добавлены дополнительные таски:
Для установки кликхаус добавлена таска ожидания прослушивания порта. Это необходимо для того, чтобы плейбук не прерывался после установки пакетов и перед таской создания БД. В изначальном плейбуке БД создавалась сразу после установки пакетов и падала ввиду проблем с портом 9000 (используется по умолчанию кликхаус БД)

```   
- name: Check if port 9000 is listening
      wait_for:
        port: 9000
        delay: 5
        timeout: 30
        msg: "Timeout waiting for 9000 to respond"
```
После того как порт 9000 становится доступен, запускается таск по созданию БД.

```
    - name: Create database
      ansible.builtin.command: "clickhouse-client -q 'create database logs;'"
      register: create_db
      failed_when: create_db.rc != 0 and create_db.rc !=82
      changed_when: create_db.rc == 0
```

Плейбук для настройки ВМ с Лайтхаус:
Хэндлер по перезапуску Nginx

```
- name: Nginx reload
    become: true
    ansible.builtin.service:
      name: nginx
      state: restarted
```

Пре-таски по установке пакетов git и добавлению репозитория для скачивания nginx

```  
pre_tasks:
   - name: install git and repo
     ansible.builtin.dnf:
      name:
        - git
        - epel-release
      state: present
```
Установка nginx

```  
    - name: nginx install
      ansible.builtin.dnf:
        name: nginx
        state: present
 ```

Создание базового конфига для nginx

```
 - name: Apply nginx config
      ansible.builtin.template:
        src: nginx.conf.j2
        dest: /etc/nginx/nginx.conf
        mode: 0644
```

Копирование гит-репозитория Лайтхаус в определнную папку на ВМ.
Переменные берутся из фалов переменных - [ссылка](https://github.com/shoonia69/ansible/blob/main/08-ansible-03-yandex/playbook/group_vars/lighthouse/vars.yml).

```
- name: copy from git
      ansible.builtin.git:
        repo: "{{ light_repo }}"
        version: master
        dest: "{{ light_dir }}"
 ```

Изменение selinux контекста, для папок Лайтхаус.
Переменные берутся из фалов переменных - [ссылка](https://github.com/shoonia69/ansible/blob/main/08-ansible-03-yandex/playbook/group_vars/lighthouse/vars.yml).

```
 - name: change selinux contex
      ansible.builtin.file:
        path: "{{ light_dir }}"
        setype: httpd_sys_content_t
        recurse: true
```

Копирование конфига Лайтхаус.
Конфиг настраивается из j2 шаблона. Файл шаблона доступен по [ссылке](https://github.com/shoonia69/ansible/blob/main/08-ansible-03-yandex/playbook/templates/lighthouse.conf.j2)

```
- name: Create Lighthouse config
      ansible.builtin.template:
        src: lighthouse.conf.j2
        dest: /etc/nginx/conf.d/lighthouse.conf
        mode: 0644
      notify: Nginx reload
```

Код выполнения плейбука:

```
[mailo@fedora playbook]$ ansible-playbook site.yml 

PLAY [Install Clickhouse] **************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************
ok: [clickhouse_vm]

TASK [Get clickhouse distrib] **********************************************************************************************************************************************************************************************
changed: [clickhouse_vm] => (item=clickhouse-client)
changed: [clickhouse_vm] => (item=clickhouse-server)
failed: [clickhouse_vm] (item=clickhouse-common-static) => {"ansible_loop_var": "item", "changed": false, "dest": "./clickhouse-common-static-22.3.3.44.rpm", "elapsed": 0, "item": "clickhouse-common-static", "msg": "Request failed", "response": "HTTP Error 404: Not Found", "status_code": 404, "url": "https://packages.clickhouse.com/rpm/stable/clickhouse-common-static-22.3.3.44.noarch.rpm"}

TASK [Get clickhouse distrib] **********************************************************************************************************************************************************************************************
changed: [clickhouse_vm]

TASK [Install clickhouse packages] *****************************************************************************************************************************************************************************************
changed: [clickhouse_vm]

TASK [Flush handlers] ******************************************************************************************************************************************************************************************************

RUNNING HANDLER [Start clickhouse service] *********************************************************************************************************************************************************************************
changed: [clickhouse_vm]

TASK [Check if port 9000 is listening] *************************************************************************************************************************************************************************************
ok: [clickhouse_vm]

TASK [Create database] *****************************************************************************************************************************************************************************************************
changed: [clickhouse_vm]

PLAY [Install Vector] ******************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************
ok: [vector_vm]

TASK [Create dir for distrib] **********************************************************************************************************************************************************************************************
changed: [vector_vm]

TASK [Get Vector distrib] **************************************************************************************************************************************************************************************************
changed: [vector_vm]

TASK [Install Vector packages] *********************************************************************************************************************************************************************************************
changed: [vector_vm]

TASK [Apply Vector template] ***********************************************************************************************************************************************************************************************
changed: [vector_vm]

RUNNING HANDLER [Start Vector service] *************************************************************************************************************************************************************************************
changed: [vector_vm]

PLAY [Install LightHouse] **************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************
ok: [lighthouse_vm]

TASK [install git and repo] ************************************************************************************************************************************************************************************************
changed: [lighthouse_vm]

TASK [nginx install] *******************************************************************************************************************************************************************************************************
changed: [lighthouse_vm]

TASK [Apply nginx config] **************************************************************************************************************************************************************************************************
changed: [lighthouse_vm]

TASK [copy from git] *******************************************************************************************************************************************************************************************************
changed: [lighthouse_vm]

TASK [change selinux contex] ***********************************************************************************************************************************************************************************************
changed: [lighthouse_vm]

TASK [Create Lighthouse config] ********************************************************************************************************************************************************************************************
changed: [lighthouse_vm]

RUNNING HANDLER [Nginx reload] *********************************************************************************************************************************************************************************************
changed: [lighthouse_vm]

PLAY RECAP *****************************************************************************************************************************************************************************************************************
clickhouse_vm              : ok=6    changed=4    unreachable=0    failed=0    skipped=0    rescued=1    ignored=0   
lighthouse_vm              : ok=8    changed=7    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
vector_vm                  : ok=6    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

